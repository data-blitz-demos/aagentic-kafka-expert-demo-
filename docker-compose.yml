x-python-app: &python-app
  build:
    context: .
    dockerfile: Dockerfile.app
  environment:
    KAFKA_BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
    SCHEMA_REGISTRY_URL: http://schema-registry:8081
    KAFKA_TOPIC: ${KAFKA_TOPIC}
    KAFKA_GROUP_ID: ${KAFKA_GROUP_ID}
    CONSUMER_UI_GROUP_ID: ${CONSUMER_UI_GROUP_ID}
    SCHEMA_FILE: /app/schemas/credit_card_purchase.avsc
    PRODUCER_RATE_SECONDS: ${PRODUCER_RATE_SECONDS}
    PRODUCER_UI_PORT: ${PRODUCER_UI_PORT}
    CONSUMER_UI_PORT: ${CONSUMER_UI_PORT}
    COUCHDB_URL: http://couchdb:5984
    COUCHDB_USER: ${COUCHDB_USER}
    COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
    COUCHDB_DB: ${COUCHDB_DB}
    CONSUMER_WRITE_COUCHDB: ${CONSUMER_WRITE_COUCHDB}
    PROMETHEUS_URL: http://prometheus:9090
    OPENAI_API_KEY: ${OPENAI_API_KEY}
    OPENAI_BASE_URL: ${OPENAI_BASE_URL}
    OPENAI_MODEL: ${OPENAI_MODEL}
    NEO4J_BROWSER_PUBLIC_URL: ${NEO4J_BROWSER_PUBLIC_URL}
    KAFKA_EXPERT_UI_PORT: ${KAFKA_EXPERT_UI_PORT}
    NEO4J_URI: bolt://neo4j:7687
    NEO4J_USERNAME: ${NEO4J_USER}
    NEO4J_PASSWORD: ${NEO4J_PASSWORD}
    NEO4J_AUTH: ${NEO4J_AUTH}
    GRAPH_RAG_MAX_CHUNKS: ${GRAPH_RAG_MAX_CHUNKS}
  volumes:
    - ./schemas:/app/schemas
    - ./output:/app/output

services:
  couchdb:
    image: couchdb:3.3
    container_name: couchdb
    hostname: couchdb
    ports:
      - "5984:5984"
    environment:
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
    volumes:
      - couchdb-data:/opt/couchdb/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/5984'"]
      interval: 10s
      timeout: 5s
      retries: 20

  neo4j:
    image: neo4j:5.26.0
    container_name: neo4j
    hostname: neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH}
    volumes:
      - neo4j-data:/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/7687'"]
      interval: 10s
      timeout: 5s
      retries: 20

  kafka1:
    image: confluentinc/cp-kafka:${CP_VERSION}
    container_name: kafka1
    hostname: kafka1
    ports:
      - "19092:19092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://kafka1:9092,CONTROLLER://kafka1:29093,PLAINTEXT_HOST://0.0.0.0:19092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:9092,PLAINTEXT_HOST://localhost:19092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:29093,2@kafka2:29093,3@kafka3:29093
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_JMX_PORT: 9991
      KAFKA_JMX_HOSTNAME: kafka1
    volumes:
      - kafka1-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/19092'"]
      interval: 10s
      timeout: 5s
      retries: 15

  kafka2:
    image: confluentinc/cp-kafka:${CP_VERSION}
    container_name: kafka2
    hostname: kafka2
    ports:
      - "29092:29092"
    environment:
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://kafka2:9092,CONTROLLER://kafka2:29093,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:29093,2@kafka2:29093,3@kafka3:29093
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_JMX_PORT: 9992
      KAFKA_JMX_HOSTNAME: kafka2
    volumes:
      - kafka2-data:/var/lib/kafka/data
    depends_on:
      - kafka1
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/29092'"]
      interval: 10s
      timeout: 5s
      retries: 15

  kafka3:
    image: confluentinc/cp-kafka:${CP_VERSION}
    container_name: kafka3
    hostname: kafka3
    ports:
      - "39092:39092"
    environment:
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://kafka3:9092,CONTROLLER://kafka3:29093,PLAINTEXT_HOST://0.0.0.0:39092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3:9092,PLAINTEXT_HOST://localhost:39092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:29093,2@kafka2:29093,3@kafka3:29093
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_JMX_PORT: 9993
      KAFKA_JMX_HOSTNAME: kafka3
    volumes:
      - kafka3-data:/var/lib/kafka/data
    depends_on:
      - kafka1
      - kafka2
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/39092'"]
      interval: 10s
      timeout: 5s
      retries: 15

  schema-registry:
    image: confluentinc/cp-schema-registry:${CP_VERSION}
    container_name: schema-registry
    hostname: schema-registry
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://kafka1:9092,PLAINTEXT://kafka2:9092,PLAINTEXT://kafka3:9092
    depends_on:
      kafka1:
        condition: service_healthy
      kafka2:
        condition: service_healthy
      kafka3:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/8081'"]
      interval: 10s
      timeout: 5s
      retries: 20

  kafka-ui:
    image: provectuslabs/kafka-ui:${KAFKA_UI_VERSION}
    container_name: kafka-ui
    hostname: kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local-confluent
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
      DYNAMIC_CONFIG_ENABLED: "true"
    depends_on:
      - schema-registry

  kafka-jmx-prom-exporter:
    image: confluentinc/cp-kafka:${CP_VERSION}
    container_name: kafka-jmx-prom-exporter
    command: ["python3", "/opt/jmx/kafka_jmx_prometheus_exporter.py"]
    environment:
      JMX_TARGETS: kafka1:9991,kafka2:9992,kafka3:9993
      JMX_POLL_INTERVAL_SECONDS: ${KAFKA_JMX_POLL_INTERVAL_SECONDS}
      JMX_EXPORTER_PORT: ${JMX_EXPORTER_PORT}
    volumes:
      - ./scripts/kafka_jmx_prometheus_exporter.py:/opt/jmx/kafka_jmx_prometheus_exporter.py:ro
    ports:
      - "${JMX_EXPORTER_PORT}:${JMX_EXPORTER_PORT}"
    depends_on:
      kafka1:
        condition: service_healthy
      kafka2:
        condition: service_healthy
      kafka3:
        condition: service_healthy
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: prometheus
    ports:
      - "${PROMETHEUS_PORT}:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/kafka-alerts.yml:/etc/prometheus/rules/kafka-alerts.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      - kafka-jmx-prom-exporter
      - node-exporter
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:v1.8.2
    container_name: node-exporter
    command:
      - --path.rootfs=/host
      - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($|/)
    volumes:
      - /:/host:ro
    ports:
      - "9100:9100"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.7
    container_name: grafana
    ports:
      - "${GRAFANA_PORT}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SECURITY_ALLOW_EMBEDDING: "true"
      GF_USERS_DEFAULT_THEME: "dark"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/dashboards:ro
    depends_on:
      - prometheus
    restart: unless-stopped

  schema-bootstrap:
    <<: *python-app
    command: ["python", "scripts/register_schema.py"]
    depends_on:
      schema-registry:
        condition: service_healthy
    restart: "no"

  consumer-ui:
    <<: *python-app
    command: ["python", "scripts/consumer_ui.py"]
    ports:
      - "${CONSUMER_UI_PORT}:${CONSUMER_UI_PORT}"
    depends_on:
      schema-bootstrap:
        condition: service_completed_successfully
      couchdb:
        condition: service_healthy
    restart: unless-stopped

  producer-ui:
    <<: *python-app
    command: ["python", "scripts/producer_ui.py"]
    ports:
      - "${PRODUCER_UI_PORT}:${PRODUCER_UI_PORT}"
    depends_on:
      schema-bootstrap:
        condition: service_completed_successfully
    restart: unless-stopped

  kafka-expert-ui:
    <<: *python-app
    command: ["python", "scripts/kafka_expert_ui.py"]
    ports:
      - "${KAFKA_EXPERT_UI_PORT}:${KAFKA_EXPERT_UI_PORT}"
    depends_on:
      prometheus:
        condition: service_started
      neo4j:
        condition: service_started
    restart: unless-stopped

  producer-rate:
    <<: *python-app
    command: ["python", "scripts/producer.py"]
    depends_on:
      schema-bootstrap:
        condition: service_completed_successfully
    profiles:
      - rate-producer
    restart: unless-stopped

volumes:
  couchdb-data:
  prometheus-data:
  grafana-data:
  kafka1-data:
  kafka2-data:
  kafka3-data:
  neo4j-data:
